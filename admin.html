<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Lead Dashboard | Meet the Contractors</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --sunset-orange: #FF6B35; --golden-yellow: #F7C948; --grass-green: #2D5A27; --sky-blue: #4A90D9; --cream: #FFF8E7; --charcoal: #2C2C2C; --white: #FFFFFF; --red: #e74c3c; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--charcoal); min-height: 100vh; }
        
        /* Login Screen */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        .login-box { background: var(--white); padding: 2.5rem; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
        .login-box h1 { font-family: 'Dela Gothic One', cursive; color: var(--grass-green); font-size: 1.5rem; margin-bottom: 0.5rem; }
        .login-box p { color: var(--charcoal); opacity: 0.7; margin-bottom: 1.5rem; }
        .login-box input { width: 100%; padding: 1rem; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem; font-family: inherit; }
        .login-box input:focus { outline: none; border-color: var(--sky-blue); }
        .login-box button { width: 100%; padding: 1rem; background: var(--sunset-orange); color: var(--white); border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .login-box button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4); }
        .login-error { color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none; }
        
        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        /* Header */
        header { background: var(--white); border-bottom: 3px solid var(--sunset-orange); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-family: 'Dela Gothic One', cursive; font-size: 1.1rem; color: var(--sunset-orange); }
        .logo span { color: var(--grass-green); }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        .btn { padding: 0.6rem 1.25rem; border-radius: 50px; font-weight: 600; font-size: 0.9rem; text-decoration: none; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.4rem; }
        .btn-primary { background: var(--sunset-orange); color: var(--white); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4); }
        .btn-secondary { background: var(--grass-green); color: var(--white); }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(45, 90, 39, 0.4); }
        .btn-outline { background: transparent; color: var(--charcoal); border: 2px solid #ddd; }
        .btn-outline:hover { border-color: var(--charcoal); }
        .btn-icon { padding: 0.6rem; min-width: auto; }
        
        /* Stats */
        .stats-bar { display: flex; gap: 1rem; padding: 1.5rem; flex-wrap: wrap; }
        .stat-card { background: var(--white); padding: 1.25rem 1.5rem; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex: 1; min-width: 120px; }
        .stat-card.vendors { border-left: 4px solid var(--sunset-orange); }
        .stat-card.paid { border-left: 4px solid var(--grass-green); }
        .stat-card.unpaid { border-left: 4px solid var(--red); }
        .stat-card.coordinators { border-left: 4px solid var(--sky-blue); }
        .stat-card h3 { font-size: 2rem; font-family: 'Dela Gothic One', cursive; color: var(--grass-green); }
        .stat-card.unpaid h3 { color: var(--red); }
        .stat-card p { font-size: 0.85rem; color: var(--charcoal); opacity: 0.7; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0.5rem; padding: 0 1.5rem; }
        .tab { padding: 0.75rem 1.5rem; background: var(--white); border: none; border-radius: 12px 12px 0 0; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 0.95rem; color: var(--charcoal); opacity: 0.6; transition: all 0.2s; }
        .tab.active { opacity: 1; background: var(--white); box-shadow: 0 -4px 15px rgba(0,0,0,0.05); }
        .tab.vendors.active { border-top: 3px solid var(--sunset-orange); }
        .tab.coordinators.active { border-top: 3px solid var(--sky-blue); }
        
        /* Table Container */
        .table-container { background: var(--white); margin: 0 1.5rem 1.5rem; border-radius: 0 16px 16px 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .table-header { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .table-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .search-box { display: flex; align-items: center; gap: 0.5rem; background: var(--cream); padding: 0.5rem 1rem; border-radius: 50px; }
        .search-box input { border: none; background: transparent; font-size: 0.9rem; font-family: inherit; width: 200px; }
        .search-box input:focus { outline: none; }
        .filter-select { padding: 0.5rem 1rem; border: 2px solid #eee; border-radius: 50px; font-size: 0.9rem; font-family: inherit; background: var(--white); cursor: pointer; }
        .filter-select:focus { outline: none; border-color: var(--sky-blue); }
        
        /* Table */
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th, td { padding: 1rem 1.25rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--cream); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--charcoal); opacity: 0.7; white-space: nowrap; }
        td { font-size: 0.95rem; }
        tr:hover td { background: rgba(247, 201, 72, 0.1); }
        .no-data { text-align: center; padding: 3rem; color: var(--charcoal); opacity: 0.5; }
        
        /* Paid Toggle */
        .paid-toggle { display: flex; align-items: center; gap: 0.5rem; }
        .toggle-switch { position: relative; width: 50px; height: 26px; background: #ddd; border-radius: 50px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch.paid { background: var(--grass-green); }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: var(--white); border-radius: 50%; transition: transform 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .toggle-switch.paid::after { transform: translateX(24px); }
        .paid-label { font-size: 0.8rem; font-weight: 600; }
        .paid-label.yes { color: var(--grass-green); }
        .paid-label.no { color: var(--red); }
        
        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 3rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--cream); border-top-color: var(--sunset-orange); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--white); border-radius: 20px; padding: 2rem; max-width: 400px; width: 100%; }
        .modal h2 { font-family: 'Dela Gothic One', cursive; color: var(--grass-green); margin-bottom: 1rem; font-size: 1.25rem; }
        .modal input { width: 100%; padding: 0.85rem 1rem; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; margin-bottom: 0.75rem; font-family: inherit; }
        .modal input:focus { outline: none; border-color: var(--sky-blue); }
        .modal-buttons { display: flex; gap: 0.75rem; margin-top: 1rem; }
        .modal-buttons button { flex: 1; }
        .modal-error { color: #e74c3c; font-size: 0.85rem; margin-bottom: 0.5rem; display: none; }
        .modal-success { color: var(--grass-green); font-size: 0.85rem; margin-bottom: 0.5rem; display: none; }
        
        /* Toast */
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--charcoal); color: var(--white); padding: 1rem 1.5rem; border-radius: 12px; font-weight: 500; opacity: 0; transform: translateY(20px); transition: all 0.3s; z-index: 1001; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: var(--grass-green); }
        .toast.error { background: var(--red); }
        
        /* Responsive */
        @media (max-width: 768px) {
            header { padding: 1rem; }
            .logo { font-size: 1rem; }
            .header-actions { flex-wrap: wrap; }
            .stats-bar { padding: 1rem; }
            .stat-card { padding: 1rem; min-width: 100px; }
            .stat-card h3 { font-size: 1.5rem; }
            .tabs { padding: 0 1rem; }
            .tab { padding: 0.6rem 1rem; font-size: 0.85rem; }
            .table-container { margin: 0 1rem 1rem; }
            .table-header { padding: 1rem; }
            .search-box input { width: 150px; }
            th, td { padding: 0.75rem 1rem; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üé™ Lead Dashboard</h1>
            <p>Enter the admin password to view leads</p>
            <div class="login-error" id="loginError">Incorrect password. Please try again.</div>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')attemptLogin()">
            <button onclick="attemptLogin()">Access Dashboard</button>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <header>
            <div class="logo">üé™ MEET THE<span> CONTRACTORS</span> - Leads</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportCSV()">üì• Export CSV</button>
                <button class="btn btn-outline" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-outline btn-icon" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </header>
        
        <div class="stats-bar" id="vendorStats">
            <div class="stat-card vendors">
                <h3 id="vendorCount">-</h3>
                <p>Total Vendors</p>
            </div>
            <div class="stat-card paid">
                <h3 id="paidCount">-</h3>
                <p>Paid</p>
            </div>
            <div class="stat-card unpaid">
                <h3 id="unpaidCount">-</h3>
                <p>Unpaid</p>
            </div>
        </div>
        
        <div class="stats-bar" id="coordinatorStats" style="display: none;">
            <div class="stat-card coordinators">
                <h3 id="coordinatorCount">-</h3>
                <p>Coordinators</p>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab vendors active" onclick="switchTab('vendors')">üî® Vendors</button>
            <button class="tab coordinators" onclick="switchTab('coordinators')">üìã Volunteers</button>
        </div>
        
        <div class="table-container">
            <div class="table-header">
                <div class="table-controls">
                    <div class="search-box">
                        <span>üîç</span>
                        <input type="text" id="searchInput" placeholder="Search leads..." oninput="filterTable()">
                    </div>
                    <select class="filter-select" id="paidFilter" onchange="filterTable()">
                        <option value="all">All Status</option>
                        <option value="paid">Paid Only</option>
                        <option value="unpaid">Unpaid Only</option>
                    </select>
                </div>
                <span id="resultCount" style="font-size: 0.9rem; opacity: 0.7;"></span>
            </div>
            <div class="table-scroll">
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                </div>
                <table id="dataTable" style="display: none;">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="no-data" id="noData" style="display: none;">No leads found</div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h2>‚öôÔ∏è Change Password</h2>
            <div class="modal-error" id="modalError"></div>
            <div class="modal-success" id="modalSuccess"></div>
            <input type="password" id="newPassword" placeholder="New password">
            <input type="password" id="confirmPassword" placeholder="Confirm new password">
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="changePassword()">Update</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const API_BASE = 'https://email-bot-server.micaiah-tasks.workers.dev';
        const VENDOR_LIST = 'meet-the-contractors-vendors';
        const COORDINATOR_LIST = 'meet-the-contractors-coordinators';
        
        let currentTab = 'vendors';
        let vendorData = [];
        let coordinatorData = [];
        let sessionPassword = '';
        
        // Check for saved session
        window.onload = function() {
            const saved = sessionStorage.getItem('mtc_session');
            if (saved) {
                sessionPassword = saved;
                showDashboard();
            }
        };
        
        async function attemptLogin() {
            const password = document.getElementById('passwordInput').value;
            if (!password) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/mtc/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    sessionPassword = password;
                    sessionStorage.setItem('mtc_session', password);
                    showDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('passwordInput').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').textContent = 'Connection error. Please try again.';
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            loadAllData();
        }
        
        function logout() {
            sessionStorage.removeItem('mtc_session');
            sessionPassword = '';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        }
        
        async function loadAllData() {
            showLoading(true);
            try {
                const [vendors, coordinators] = await Promise.all([
                    fetchSubscribers(VENDOR_LIST),
                    fetchSubscribers(COORDINATOR_LIST)
                ]);
                
                vendorData = vendors;
                coordinatorData = coordinators;
                
                updateStats();
                renderTable();
            } catch (error) {
                console.error('Load error:', error);
                if (error.message.includes('401')) {
                    logout();
                }
            }
            showLoading(false);
        }
        
        function updateStats() {
            const paidVendors = vendorData.filter(v => {
                const meta = v.metadata ? (typeof v.metadata === 'string' ? JSON.parse(v.metadata) : v.metadata) : {};
                return meta.paid === true;
            }).length;
            
            document.getElementById('vendorCount').textContent = vendorData.length;
            document.getElementById('paidCount').textContent = paidVendors;
            document.getElementById('unpaidCount').textContent = vendorData.length - paidVendors;
            document.getElementById('coordinatorCount').textContent = coordinatorData.length;
        }
        
        async function fetchSubscribers(listSlug) {
            const response = await fetch(`${API_BASE}/api/mtc/leads?list=${listSlug}`, {
                headers: { 'X-MTC-Password': sessionPassword }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            return data.subscribers || [];
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab.${tab}`).classList.add('active');
            document.getElementById('searchInput').value = '';
            document.getElementById('paidFilter').value = 'all';
            
            // Show/hide appropriate stats
            document.getElementById('vendorStats').style.display = tab === 'vendors' ? 'flex' : 'none';
            document.getElementById('coordinatorStats').style.display = tab === 'coordinators' ? 'flex' : 'none';
            
            // Show/hide paid filter
            document.getElementById('paidFilter').style.display = tab === 'vendors' ? 'block' : 'none';
            
            renderTable();
        }
        
        function renderTable() {
            const data = currentTab === 'vendors' ? vendorData : coordinatorData;
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const table = document.getElementById('dataTable');
            const noData = document.getElementById('noData');
            
            if (data.length === 0) {
                table.style.display = 'none';
                noData.style.display = 'block';
                document.getElementById('resultCount').textContent = '';
                return;
            }
            
            table.style.display = 'table';
            noData.style.display = 'none';
            
            // Headers based on tab
            if (currentTab === 'vendors') {
                thead.innerHTML = '<tr><th>Paid</th><th>Date</th><th>Name</th><th>Company</th><th>Email</th><th>Phone</th><th>Services</th></tr>';
            } else {
                thead.innerHTML = '<tr><th>Date</th><th>Name</th><th>Email</th><th>Phone</th><th>Availability</th></tr>';
            }
            
            // Rows
            tbody.innerHTML = data.map((sub, index) => {
                const meta = sub.metadata ? (typeof sub.metadata === 'string' ? JSON.parse(sub.metadata) : sub.metadata) : {};
                const date = new Date(sub.subscribed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const name = sub.name || `${meta.first_name || ''} ${meta.last_name || ''}`.trim() || '-';
                const isPaid = meta.paid === true;
                
                if (currentTab === 'vendors') {
                    return `<tr data-paid="${isPaid}" data-email="${sub.email}">
                        <td>
                            <div class="paid-toggle">
                                <div class="toggle-switch ${isPaid ? 'paid' : ''}" onclick="togglePaid('${sub.email}', ${!isPaid})"></div>
                                <span class="paid-label ${isPaid ? 'yes' : 'no'}">${isPaid ? 'Yes' : 'No'}</span>
                            </div>
                        </td>
                        <td>${date}</td>
                        <td>${escapeHtml(name)}</td>
                        <td>${escapeHtml(meta.company_name || '-')}</td>
                        <td><a href="mailto:${sub.email}">${sub.email}</a></td>
                        <td>${escapeHtml(meta.phone || '-')}</td>
                        <td>${escapeHtml(meta.services || '-')}</td>
                    </tr>`;
                } else {
                    return `<tr>
                        <td>${date}</td>
                        <td>${escapeHtml(name)}</td>
                        <td><a href="mailto:${sub.email}">${sub.email}</a></td>
                        <td>${escapeHtml(meta.phone || '-')}</td>
                        <td>${escapeHtml(meta.availability || '-')}</td>
                    </tr>`;
                }
            }).join('');
            
            document.getElementById('resultCount').textContent = `${data.length} leads`;
            filterTable();
        }
        
        async function togglePaid(email, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/api/mtc/update-status`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-MTC-Password': sessionPassword
                    },
                    body: JSON.stringify({ 
                        email: email,
                        list: VENDOR_LIST,
                        paid: newStatus
                    })
                });
                
                if (response.ok) {
                    // Update local data
                    const vendor = vendorData.find(v => v.email === email);
                    if (vendor) {
                        const meta = vendor.metadata ? (typeof vendor.metadata === 'string' ? JSON.parse(vendor.metadata) : vendor.metadata) : {};
                        meta.paid = newStatus;
                        vendor.metadata = meta;
                    }
                    
                    updateStats();
                    renderTable();
                    showToast(newStatus ? 'Marked as paid ‚úì' : 'Marked as unpaid', 'success');
                } else {
                    showToast('Failed to update status', 'error');
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('Connection error', 'error');
            }
        }
        
        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const paidFilter = document.getElementById('paidFilter').value;
            const rows = document.querySelectorAll('#tableBody tr');
            let visible = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const isPaid = row.dataset.paid === 'true';
                
                let matchSearch = text.includes(search);
                let matchPaid = paidFilter === 'all' || 
                    (paidFilter === 'paid' && isPaid) || 
                    (paidFilter === 'unpaid' && !isPaid);
                
                const show = matchSearch && matchPaid;
                row.style.display = show ? '' : 'none';
                if (show) visible++;
            });
            
            const total = currentTab === 'vendors' ? vendorData.length : coordinatorData.length;
            const filtered = search || paidFilter !== 'all';
            document.getElementById('resultCount').textContent = filtered ? `${visible} of ${total} leads` : `${total} leads`;
        }
        
        function exportCSV() {
            const data = currentTab === 'vendors' ? vendorData : coordinatorData;
            if (data.length === 0) return alert('No data to export');
            
            let csv = '';
            
            if (currentTab === 'vendors') {
                csv = 'Date,First Name,Last Name,Company,Email,Phone,Services,Paid\n';
                data.forEach(sub => {
                    const meta = sub.metadata ? (typeof sub.metadata === 'string' ? JSON.parse(sub.metadata) : sub.metadata) : {};
                    const date = new Date(sub.subscribed_at).toLocaleDateString();
                    const paid = meta.paid === true ? 'Yes' : 'No';
                    csv += `"${date}","${meta.first_name || ''}","${meta.last_name || ''}","${meta.company_name || ''}","${sub.email}","${meta.phone || ''}","${meta.services || ''}","${paid}"\n`;
                });
            } else {
                csv = 'Date,First Name,Last Name,Email,Phone,Availability\n';
                data.forEach(sub => {
                    const meta = sub.metadata ? (typeof sub.metadata === 'string' ? JSON.parse(sub.metadata) : sub.metadata) : {};
                    const date = new Date(sub.subscribed_at).toLocaleDateString();
                    csv += `"${date}","${meta.first_name || ''}","${meta.last_name || ''}","${sub.email}","${meta.phone || ''}","${meta.availability || ''}"\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTab}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function refreshData() {
            loadAllData();
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
            document.getElementById('dataTable').style.display = show ? 'none' : 'table';
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('modalSuccess').style.display = 'none';
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        async function changePassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('modalError');
            const successEl = document.getElementById('modalSuccess');
            
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (!newPass || newPass.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.style.display = 'block';
                return;
            }
            
            if (newPass !== confirmPass) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/mtc/password`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-MTC-Password': sessionPassword
                    },
                    body: JSON.stringify({ newPassword: newPass })
                });
                
                if (response.ok) {
                    sessionPassword = newPass;
                    sessionStorage.setItem('mtc_session', newPass);
                    successEl.textContent = 'Password updated successfully!';
                    successEl.style.display = 'block';
                    setTimeout(closeSettings, 1500);
                } else {
                    const data = await response.json();
                    errorEl.textContent = data.error || 'Failed to update password';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }
        
        // Close modal on overlay click
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });
    </script>
</body>
</html>