<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Dashboard | Meet the Contractors</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --sunset-orange: #FF6B35; --golden-yellow: #F7C948; --grass-green: #2D5A27; --sky-blue: #4A90D9; --cream: #FFF8E7; --charcoal: #2C2C2C; --white: #FFFFFF; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--charcoal); min-height: 100vh; }
        
        /* Login Screen */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        .login-box { background: var(--white); padding: 2.5rem; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
        .login-box h1 { font-family: 'Dela Gothic One', cursive; color: var(--grass-green); font-size: 1.5rem; margin-bottom: 0.5rem; }
        .login-box p { color: var(--charcoal); opacity: 0.7; margin-bottom: 1.5rem; }
        .login-box input { width: 100%; padding: 1rem; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem; font-family: inherit; }
        .login-box input:focus { outline: none; border-color: var(--sky-blue); }
        .login-box button { width: 100%; padding: 1rem; background: var(--sunset-orange); color: var(--white); border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .login-box button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4); }
        .login-error { color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none; }
        
        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        /* Header */
        header { background: var(--white); border-bottom: 3px solid var(--sunset-orange); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-family: 'Dela Gothic One', cursive; font-size: 1.1rem; color: var(--sunset-orange); }
        .logo span { color: var(--grass-green); }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }
        .btn { padding: 0.6rem 1.25rem; border-radius: 50px; font-weight: 600; font-size: 0.9rem; text-decoration: none; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.4rem; }
        .btn-primary { background: var(--sunset-orange); color: var(--white); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4); }
        .btn-secondary { background: var(--grass-green); color: var(--white); }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(45, 90, 39, 0.4); }
        .btn-outline { background: transparent; color: var(--charcoal); border: 2px solid #ddd; }
        .btn-outline:hover { border-color: var(--charcoal); }
        
        /* Stats */
        .stats-bar { display: flex; gap: 1rem; padding: 1.5rem; flex-wrap: wrap; }
        .stat-card { background: var(--white); padding: 1.25rem 1.5rem; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex: 1; min-width: 150px; }
        .stat-card.vendors { border-left: 4px solid var(--sunset-orange); }
        .stat-card.coordinators { border-left: 4px solid var(--sky-blue); }
        .stat-card h3 { font-size: 2rem; font-family: 'Dela Gothic One', cursive; color: var(--grass-green); }
        .stat-card p { font-size: 0.85rem; color: var(--charcoal); opacity: 0.7; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0.5rem; padding: 0 1.5rem; }
        .tab { padding: 0.75rem 1.5rem; background: var(--white); border: none; border-radius: 12px 12px 0 0; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 0.95rem; color: var(--charcoal); opacity: 0.6; transition: all 0.2s; }
        .tab.active { opacity: 1; background: var(--white); box-shadow: 0 -4px 15px rgba(0,0,0,0.05); }
        .tab.vendors.active { border-top: 3px solid var(--sunset-orange); }
        .tab.coordinators.active { border-top: 3px solid var(--sky-blue); }
        
        /* Table Container */
        .table-container { background: var(--white); margin: 0 1.5rem 1.5rem; border-radius: 0 16px 16px 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .table-header { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .search-box { display: flex; align-items: center; gap: 0.5rem; background: var(--cream); padding: 0.5rem 1rem; border-radius: 50px; }
        .search-box input { border: none; background: transparent; font-size: 0.9rem; font-family: inherit; width: 200px; }
        .search-box input:focus { outline: none; }
        
        /* Table */
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 1rem 1.25rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--cream); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--charcoal); opacity: 0.7; white-space: nowrap; }
        td { font-size: 0.95rem; }
        tr:hover td { background: rgba(247, 201, 72, 0.1); }
        .no-data { text-align: center; padding: 3rem; color: var(--charcoal); opacity: 0.5; }
        
        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 3rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--cream); border-top-color: var(--sunset-orange); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 768px) {
            header { padding: 1rem; }
            .logo { font-size: 1rem; }
            .stats-bar { padding: 1rem; }
            .stat-card { padding: 1rem; }
            .stat-card h3 { font-size: 1.5rem; }
            .tabs { padding: 0 1rem; }
            .tab { padding: 0.6rem 1rem; font-size: 0.85rem; }
            .table-container { margin: 0 1rem 1rem; }
            .table-header { padding: 1rem; }
            .search-box input { width: 150px; }
            th, td { padding: 0.75rem 1rem; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üé™ Lead Dashboard</h1>
            <p>Enter the admin password to view leads</p>
            <div class="login-error" id="loginError">Incorrect password. Please try again.</div>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')attemptLogin()">
            <button onclick="attemptLogin()">Access Dashboard</button>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <header>
            <div class="logo">üé™ MEET THE<span> CONTRACTORS</span> - Leads</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportCSV()">üì• Export CSV</button>
                <button class="btn btn-outline" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </header>
        
        <div class="stats-bar">
            <div class="stat-card vendors">
                <h3 id="vendorCount">-</h3>
                <p>Registered Vendors</p>
            </div>
            <div class="stat-card coordinators">
                <h3 id="coordinatorCount">-</h3>
                <p>Coordinators</p>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab vendors active" onclick="switchTab('vendors')">üî® Vendors</button>
            <button class="tab coordinators" onclick="switchTab('coordinators')">üìã Coordinators</button>
        </div>
        
        <div class="table-container">
            <div class="table-header">
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" id="searchInput" placeholder="Search leads..." oninput="filterTable()">
                </div>
                <span id="resultCount" style="font-size: 0.9rem; opacity: 0.7;"></span>
            </div>
            <div class="table-scroll">
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                </div>
                <table id="dataTable" style="display: none;">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="no-data" id="noData" style="display: none;">No leads found</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://email-bot-server.micaiah-tasks.workers.dev';
        const VENDOR_LIST = 'meet-the-contractors-vendors';
        const COORDINATOR_LIST = 'meet-the-contractors-coordinators';
        
        let currentTab = 'vendors';
        let vendorData = [];
        let coordinatorData = [];
        let sessionPassword = '';
        
        // Check for saved session
        window.onload = function() {
            const saved = sessionStorage.getItem('mtc_session');
            if (saved) {
                sessionPassword = saved;
                showDashboard();
            }
        };
        
        async function attemptLogin() {
            const password = document.getElementById('passwordInput').value;
            if (!password) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/mtc/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    sessionPassword = password;
                    sessionStorage.setItem('mtc_session', password);
                    showDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('passwordInput').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').textContent = 'Connection error. Please try again.';
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            loadAllData();
        }
        
        function logout() {
            sessionStorage.removeItem('mtc_session');
            sessionPassword = '';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        }
        
        async function loadAllData() {
            showLoading(true);
            try {
                const [vendors, coordinators] = await Promise.all([
                    fetchSubscribers(VENDOR_LIST),
                    fetchSubscribers(COORDINATOR_LIST)
                ]);
                
                vendorData = vendors;
                coordinatorData = coordinators;
                
                document.getElementById('vendorCount').textContent = vendors.length;
                document.getElementById('coordinatorCount').textContent = coordinators.length;
                
                renderTable();
            } catch (error) {
                console.error('Load error:', error);
                if (error.message.includes('401')) {
                    logout();
                }
            }
            showLoading(false);
        }
        
        async function fetchSubscribers(listSlug) {
            const response = await fetch(`${API_BASE}/api/mtc/leads?list=${listSlug}`, {
                headers: { 'X-MTC-Password': sessionPassword }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            return data.subscribers || [];
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab.${tab}`).classList.add('active');
            document.getElementById('searchInput').value = '';
            renderTable();
        }
        
        function renderTable() {
            const data = currentTab === 'vendors' ? vendorData : coordinatorData;
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const table = document.getElementById('dataTable');
            const noData = document.getElementById('noData');
            
            if (data.length === 0) {
                table.style.display = 'none';
                noData.style.display = 'block';
                document.getElementById('resultCount').textContent = '';
                return;
            }
            
            table.style.display = 'table';
            noData.style.display = 'none';
            
            // Headers based on tab
            if (currentTab === 'vendors') {
                thead.innerHTML = '<tr><th>Date</th><th>Name</th><th>Company</th><th>Email</th><th>Phone</th><th>Services</th></tr>';
            } else {
                thead.innerHTML = '<tr><th>Date</th><th>Name</th><th>Email</th><th>Phone</th><th>Availability</th></tr>';
            }
            
            // Rows
            tbody.innerHTML = data.map(sub => {
                const meta = sub.metadata ? (typeof sub.metadata === 'string' ? JSON.parse(sub.metadata) : sub.metadata) : {};
                const date = new Date(sub.subscribed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const name = sub.name || `${meta.first_name || ''} ${meta.last_name || ''}`.trim() || '-';
                
                if (currentTab === 'vendors') {
                    return `<tr>
                        <td>${date}</td>
                        <td>${escapeHtml(name)}</td>
                        <td>${escapeHtml(meta.company_name || '-')}</td>
                        <td><a href="mailto:${sub.email}">${sub.email}</a></td>
                        <td>${escapeHtml(meta.phone || '-')}</td>
                        <td>${escapeHtml(meta.services || '-')}</td>
                    </tr>`;
                } else {
                    return `<tr>
                        <td>${date}</td>
                        <td>${escapeHtml(name)}</td>
                        <td><a href="mailto:${sub.email}">${sub.email}</a></td>
                        <td>${escapeHtml(meta.phone || '-')}</td>
                        <td>${escapeHtml(meta.availability || '-')}</td>
                    </tr>`;
                }
            }).join('');
            
            document.getElementById('resultCount').textContent = `${data.length} leads`;
        }
        
        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            let visible = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const match = text.includes(search);
                row.style.display = match ? '' : 'none';
                if (match) visible++;
            });
            
            const total = currentTab === 'vendors' ? vendorData.length : coordinatorData.length;
            document.getElementById('resultCount').textContent = search ? `${visible} of ${total} leads` : `${total} leads`;
        }
        
        function exportCSV() {
            const data = currentTab === 'vendors' ? vendorData : coordinatorData;
            if (data.length === 0) return alert('No data to export');
            
            let csv = '';
            
            if (currentTab === 'vendors') {
                csv = 'Date,First Name,Last Name,Company,Email,Phone,Services\n';
                data.forEach(sub => {
                    const meta = sub.metadata ? (typeof sub.metadata === 'string' ? JSON.parse(sub.metadata) : sub.metadata) : {};
                    const date = new Date(sub.subscribed_at).toLocaleDateString();
                    csv += `"${date}","${meta.first_name || ''}","${meta.last_name || ''}","${meta.company_name || ''}","${sub.email}","${meta.phone || ''}","${meta.services || ''}"\n`;
                });
            } else {
                csv = 'Date,First Name,Last Name,Email,Phone,Availability\n';
                data.forEach(sub => {
                    const meta = sub.metadata ? (typeof sub.metadata === 'string' ? JSON.parse(sub.metadata) : sub.metadata) : {};
                    const date = new Date(sub.subscribed_at).toLocaleDateString();
                    csv += `"${date}","${meta.first_name || ''}","${meta.last_name || ''}","${sub.email}","${meta.phone || ''}","${meta.availability || ''}"\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTab}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function refreshData() {
            loadAllData();
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
            document.getElementById('dataTable').style.display = show ? 'none' : 'table';
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
    </script>
</body>
</html>
